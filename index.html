<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>3D Фрактал Мандельброта</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            overflow: hidden;
            touch-action: none;
            -webkit-tap-highlight-color: transparent;
            font-family: Arial, sans-serif;
            background: #000;
        }
        canvas {
            display: block;
        }
        .controls {
            position: absolute;
            bottom: 20px;
            left: 0;
            right: 0;
            text-align: center;
            color: white;
            font-size: 14px;
            pointer-events: none;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.8);
            padding: 0 20px;
            z-index: 100;
        }
        .loading {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-size: 18px;
            text-align: center;
            z-index: 1000;
        }
        .progress {
            width: 80%;
            max-width: 300px;
            height: 10px;
            background: rgba(255,255,255,0.2);
            border-radius: 5px;
            margin: 10px auto;
            overflow: hidden;
        }
        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #ff8a00, #e52e71);
            width: 0%;
            transition: width 0.3s ease;
        }
    </style>
</head>
<body>
    <div class="loading">
        <div>Загрузка 3D фрактала...</div>
        <div class="progress">
            <div class="progress-bar" id="progressBar"></div>
        </div>
        <div id="progressText">0%</div>
    </div>
    <div class="controls">Свайп для перемещения · Два пальца для масштабирования</div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Основные переменные
            let camera, scene, renderer;
            let fractalMesh;
            let isRotating = false;
            let previousTouchDistance = null;
            let initialTouches = [];
            
            // Параметры фрактала
            const fractalParams = {
                resolution: 32,  // Высокое разрешение для точности
                iterations: 12,
                scale: 2.0,
                power: 8,
                threshold: 0.5
            };
            
            // Элементы прогресса
            const progressBar = document.getElementById('progressBar');
            const progressText = document.getElementById('progressText');
            let totalPoints = 0;
            let processedPoints = 0;
            
            // Инициализация сцены
            function init() {
                // Создание сцены
                scene = new THREE.Scene();
                scene.background = new THREE.Color(0x000000);
                
                // Создание камеры
                const aspectRatio = window.innerWidth / window.innerHeight;
                camera = new THREE.PerspectiveCamera(75, aspectRatio, 0.1, 1000);
                camera.position.z = 5;
                
                // Создание рендерера
                renderer = new THREE.WebGLRenderer({ antialias: true });
                renderer.setSize(window.innerWidth, window.innerHeight);
                renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
                document.body.appendChild(renderer.domElement);
                
                // Добавление освещения
                const ambientLight = new THREE.AmbientLight(0x333333);
                scene.add(ambientLight);
                
                const directionalLight = new THREE.DirectionalLight(0xFFFFFF, 0.7);
                directionalLight.position.set(5, 5, 5);
                scene.add(directionalLight);
                
                // Создание 3D фрактала в фоновом режиме с прогрессом
                createFractalWithProgress();
                
                // Обработка событий
                setupEventListeners();
                
                // Запуск анимации
                animate();
            }
            
            // Создание 3D фрактала с индикатором прогресса
            function createFractalWithProgress() {
                // Создание геометрии для точек фрактала
                const geometry = new THREE.BufferGeometry();
                const positions = [];
                const colors = [];
                
                // Генерация точек фрактала
                const size = fractalParams.resolution;
                const halfSize = size / 2;
                
                // Вычисление общего количества точек
                totalPoints = size * size * size;
                
                // Создание фрактала по частям с помощью requestAnimationFrame
                let x = 0, y = 0, z = 0;
                
                function generateNextBatch() {
                    const batchSize = 1000; // Количество точек за один кадр
                    let pointsGenerated = 0;
                    
                    while (pointsGenerated < batchSize && z < size) {
                        // Нормализованные координаты
                        const nx = (x - halfSize) / halfSize;
                        const ny = (y - halfSize) / halfSize;
                        const nz = (z - halfSize) / halfSize;
                        
                        // Вычисление фрактала
                        const value = mandelbulb(nx, ny, nz, fractalParams);
                        
                        if (value > fractalParams.threshold) {
                            positions.push(nx * fractalParams.scale, ny * fractalParams.scale, nz * fractalParams.scale);
                            
                            // Цвет на основе позиции
                            colors.push(
                                (x / size) * 0.5 + 0.5,
                                (y / size) * 0.3 + 0.5,
                                (z / size) * 0.8 + 0.2
                            );
                        }
                        
                        // Переход к следующей точке
                        x++;
                        if (x >= size) {
                            x = 0;
                            y++;
                            if (y >= size) {
                                y = 0;
                                z++;
                            }
                        }
                        
                        pointsGenerated++;
                        processedPoints++;
                    }
                    
                    // Обновление прогресса
                    const progress = (processedPoints / totalPoints) * 100;
                    progressBar.style.width = progress + '%';
                    progressText.textContent = Math.round(progress) + '%';
                    
                    if (z < size) {
                        // Продолжаем генерацию
                        requestAnimationFrame(generateNextBatch);
                    } else {
                        // Завершение генерации
                        finishFractalGeneration(geometry, positions, colors);
                    }
                }
                
                // Запуск генерации
                generateNextBatch();
            }
            
            // Завершение генерации фрактала
            function finishFractalGeneration(geometry, positions, colors) {
                // Установка атрибутов геометрии
                geometry.setAttribute('position', new THREE.Float32BufferAttribute(positions, 3));
                geometry.setAttribute('color', new THREE.Float32BufferAttribute(colors, 3));
                
                // Материал для точек
                const material = new THREE.PointsMaterial({
                    size: 0.03,
                    vertexColors: true,
                    sizeAttenuation: true
                });
                
                // Создание mesh
                fractalMesh = new THREE.Points(geometry, material);
                scene.add(fractalMesh);
                
                // Скрытие сообщения о загрузке
                document.querySelector('.loading').style.display = 'none';
            }
            
            // Функция для вычисления 3D фрактала Мандельброта (Mandelbulb)
            function mandelbulb(x, y, z, params) {
                let zx = x;
                let zy = y;
                let zz = z;
                
                let dr = 1.0;
                let r = 0.0;
                
                for (let i = 0; i < params.iterations; i++) {
                    r = Math.sqrt(zx * zx + zy * zy + zz * zz);
                    if (r > 2) break;
                    
                    // Конвертация в сферические координаты
                    let theta = Math.acos(zz / r);
                    let phi = Math.atan2(zy, zx);
                    
                    dr = Math.pow(r, params.power - 1.0) * params.power * dr + 1.0;
                    
                    // Возведение в степень и поворот
                    const zr = Math.pow(r, params.power);
                    theta = theta * params.power;
                    phi = phi * params.power;
                    
                    // Конвертация обратно в декартовы координаты
                    zx = zr * Math.sin(theta) * Math.cos(phi) + x;
                    zy = zr * Math.sin(theta) * Math.sin(phi) + y;
                    zz = zr * Math.cos(theta) + z;
                }
                
                return 0.5 * Math.log(r) * r / dr;
            }
            
            // Настройка обработчиков событий
            function setupEventListeners() {
                // Обработка одинарных касаний (перетаскивание)
                renderer.domElement.addEventListener('touchstart', onTouchStart, { passive: false });
                renderer.domElement.addEventListener('touchmove', onTouchMove, { passive: false });
                renderer.domElement.addEventListener('touchend', onTouchEnd, { passive: false });
                
                // Обработка изменения размера окна
                window.addEventListener('resize', onWindowResize, false);
            }
            
            // Обработка начала касания
            function onTouchStart(event) {
                event.preventDefault();
                
                if (event.touches.length === 1) {
                    isRotating = true;
                    initialTouches = [{
                        x: event.touches[0].clientX,
                        y: event.touches[0].clientY
                    }];
                } else if (event.touches.length === 2) {
                    isRotating = false;
                    // Расчет начального расстояния между двумя пальцами
                    previousTouchDistance = Math.hypot(
                        event.touches[0].clientX - event.touches[1].clientX,
                        event.touches[0].clientY - event.touches[1].clientY
                    );
                }
            }
            
            // Обработка перемещения пальцев
            function onTouchMove(event) {
                event.preventDefault();
                
                if (event.touches.length === 1 && isRotating) {
                    // Вращение фрактала
                    const touchX = event.touches[0].clientX;
                    const touchY = event.touches[0].clientY;
                    
                    const movementX = touchX - initialTouches[0].x;
                    const movementY = touchY - initialTouches[0].y;
                    
                    if (fractalMesh) {
                        fractalMesh.rotation.y += movementX * 0.01;
                        fractalMesh.rotation.x += movementY * 0.01;
                    }
                    
                    initialTouches[0] = { x: touchX, y: touchY };
                } else if (event.touches.length === 2) {
                    // Масштабирование фрактала
                    const touchDistance = Math.hypot(
                        event.touches[0].clientX - event.touches[1].clientX,
                        event.touches[0].clientY - event.touches[1].clientY
                    );
                    
                    if (previousTouchDistance !== null) {
                        const zoomFactor = touchDistance / previousTouchDistance;
                        camera.position.z *= 1 / zoomFactor;
                        
                        // Ограничение масштабирования
                        camera.position.z = Math.max(2, Math.min(20, camera.position.z));
                    }
                    
                    previousTouchDistance = touchDistance;
                }
            }
            
            // Обработка завершения касания
            function onTouchEnd(event) {
                event.preventDefault();
                isRotating = false;
                previousTouchDistance = null;
            }
            
            // Обработка изменения размера окна
            function onWindowResize() {
                camera.aspect = window.innerWidth / window.innerHeight;
                camera.updateProjectionMatrix();
                renderer.setSize(window.innerWidth, window.innerHeight);
            }
            
            // Функция анимации
            function animate() {
                requestAnimationFrame(animate);
                
                // Медленное автоматическое вращение
                if (fractalMesh) {
                    fractalMesh.rotation.y += 0.003;
                }
                
                renderer.render(scene, camera);
            }
            
            // Запуск инициализации
            init();
        });
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Реалистичная симуляция элементарных частиц</title>
    <style>
        :root {
            --bg-color: #f8f9fa;
            --text-color: #2c3e50;
            --panel-bg: rgba(255, 255, 255, 0.95);
            --border-color: #dee2e6;
        }
        
        body {
            margin: 0;
            padding: 0;
            overflow: hidden;
            touch-action: none;
            -webkit-tap-highlight-color: transparent;
            background: var(--bg-color);
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            color: var(--text-color);
        }
        
        canvas {
            display: block;
            background: var(--bg-color);
        }
        
        .controls-panel {
            position: absolute;
            top: 10px;
            left: 10px;
            right: 10px;
            background: var(--panel-bg);
            border-radius: 12px;
            padding: 15px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            max-height: 50vh;
            overflow-y: auto;
            border: 1px solid var(--border-color);
        }
        
        .panel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .particle-types {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 15px;
        }
        
        .particle-type {
            padding: 8px 12px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 13px;
            border: 2px solid transparent;
            transition: all 0.2s;
            font-weight: 500;
            color: var(--text-color);
        }
        
        .particle-type.active {
            border-color: var(--text-color);
            transform: scale(1.05);
        }
        
        .btn {
            background: #6c757d;
            color: white;
            border: none;
            border-radius: 8px;
            padding: 8px 16px;
            cursor: pointer;
            font-size: 13px;
            transition: background 0.2s;
        }
        
        .btn:hover {
            background: #5a6268;
        }
        
        .btn-primary {
            background: #3498db;
        }
        
        .btn-primary:hover {
            background: #2980b9;
        }
        
        .btn-danger {
            background: #e74c3c;
        }
        
        .btn-danger:hover {
            background: #c0392b;
        }
        
        .particle-params {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid var(--border-color);
        }
        
        .param-slider {
            display: flex;
            flex-direction: column;
            margin-bottom: 8px;
        }
        
        .param-label {
            font-size: 12px;
            margin-bottom: 4px;
            font-weight: 500;
        }
        
        .param-value {
            font-size: 11px;
            text-align: center;
            color: #7f8c8d;
        }
        
        input[type="range"] {
            width: 100%;
            height: 4px;
            border-radius: 2px;
            background: #ddd;
            outline: none;
        }
        
        .preset-buttons {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
            margin-top: 15px;
        }
        
        .preset-btn {
            background: #ecf0f1;
            color: var(--text-color);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 6px;
            cursor: pointer;
            font-size: 11px;
            transition: all 0.2s;
        }
        
        .preset-btn:hover {
            background: #dde4e6;
        }
        
        .stats {
            position: absolute;
            bottom: 10px;
            left: 10px;
            background: var(--panel-bg);
            border-radius: 8px;
            padding: 10px;
            font-size: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            border: 1px solid var(--border-color);
        }
        
        .delete-btn {
            margin-left: 5px;
            background: none;
            border: none;
            color: #e74c3c;
            cursor: pointer;
            font-size: 14px;
            padding: 0 4px;
        }
    </style>
</head>
<body>
    <div class="controls-panel">
        <div class="panel-header">
            <h3 style="margin: 0; font-size: 16px;">Симуляция частиц</h3>
            <div>
                <button class="btn btn-primary" id="addParticleTypeBtn">+ Тип</button>
                <button class="btn" id="clearBtn">Очистить</button>
            </div>
        </div>
        
        <div class="particle-types" id="particleTypes">
            <!-- Типы частиц будут добавляться здесь -->
        </div>
        
        <div class="particle-params" id="particleParams" style="display: none;">
            <!-- Параметры будут добавляться здесь -->
        </div>
        
        <div class="preset-buttons">
            <button class="preset-btn" data-preset="electron">Электрон</button>
            <button class="preset-btn" data-preset="proton">Протон</button>
            <button class="preset-btn" data-preset="neutron">Нейтрон</button>
            <button class="preset-btn" data-preset="photon">Фотон</button>
            <button class="preset-btn" data-preset="muon">Мюон</button>
            <button class="preset-btn" data-preset="quarkUp">Кварк u</button>
            <button class="preset-btn" data-preset="quarkDown">Кварк d</button>
            <button class="preset-btn" data-preset="positron">Позитрон</button>
            <button class="preset-btn" data-preset="alpha">Альфа</button>
        </div>
    </div>
    
    <div class="stats" id="stats">
        Частиц: 0 | FPS: 0
    </div>
    
    <canvas id="canvas"></canvas>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const canvas = document.getElementById('canvas');
            const ctx = canvas.getContext('2d');
            const particleTypesContainer = document.getElementById('particleTypes');
            const particleParamsContainer = document.getElementById('particleParams');
            const addParticleTypeBtn = document.getElementById('addParticleTypeBtn');
            const clearBtn = document.getElementById('clearBtn');
            const statsElement = document.getElementById('stats');
            const presetButtons = document.querySelectorAll('.preset-btn');
            
            // Установка размеров canvas
            function resizeCanvas() {
                canvas.width = window.innerWidth;
                canvas.height = window.innerHeight;
            }
            resizeCanvas();
            window.addEventListener('resize', resizeCanvas);
            
            // Система частиц
            let particles = [];
            let particleTypes = [];
            let activeTypeIndex = 0;
            let nextColorIndex = 0;
            let fps = 0;
            let lastFpsUpdate = 0;
            let frameCount = 0;
            let physicsConstants = {
                coulomb: 8.99e9, // Постоянная Кулона (N·m²/C²)
                gravitational: 6.67430e-11, // Гравитационная постоянная (N·m²/kg²)
                weakForce: 1e-5, // Слабое взаимодействие (условная)
                strongForce: 1e4 // Сильное взаимодействие (условная)
            };
            
            // Пастельная цветовая палитра
            const pastelColors = [
                '#a8e6cf', '#dcedc1', '#ffd3b6', '#ffaaa5', '#ff8b94',
                '#b5e8d6', '#c9e9d6', '#e2f0cb', '#d4e2d4', '#ffccd5',
                '#c7ceea', '#e2c2ff', '#c2eaff', '#ffdac1', '#b5ead7'
            ];
            
            // Класс типа частицы с реалистичными параметрами
            class ParticleType {
                constructor(name, color, params = {}) {
                    this.name = name;
                    this.color = color;
                    
                    // Физические параметры (в реальных единицах измерения)
                    this.mass = params.mass || 9.11e-31; // кг (масса электрона)
                    this.charge = params.charge || 0; // Кл
                    this.spin = params.spin || 0; // ħ
                    this.lifetime = params.lifetime || Infinity; // с
                    this.interactions = params.interactions || {
                        electromagnetic: true,
                        gravitational: false, // По умолчанию выключена
                        weak: false,
                        strong: false
                    };
                    
                    // Квантовые числа
                    this.leptonNumber = params.leptonNumber || 0;
                    this.baryonNumber = params.baryonNumber || 0;
                    this.strangeness = params.strangeness || 0;
                    
                    // Визуальные параметры (масштабированные для отображения)
                    this.displaySize = Math.max(2, Math.min(10, Math.cbrt(this.mass / 9.11e-31) * 3));
                    this.glow = params.glow || false;
                }
                
                // Вычисление силы взаимодействия с другой частицей
                calculateForce(otherParticle, distance) {
                    const forces = { x: 0, y: 0 };
                    const minDistance = 10; // Минимальное расстояние для избежания сингулярности
                    const effectiveDistance = Math.max(distance, minDistance);
                    
                    // Электромагнитное взаимодействие (закон Кулона)
                    if (this.interactions.electromagnetic && otherParticle.type.interactions.electromagnetic) {
                        const emForce = physicsConstants.coulomb * this.charge * otherParticle.type.charge / 
                                       (effectiveDistance * effectiveDistance);
                        // Масштабируем для визуализации
                        forces.x += emForce * 1e20;
                        forces.y += emForce * 1e20;
                    }
                    
                    // Гравитационное взаимодействие
                    if (this.interactions.gravitational && otherParticle.type.interactions.gravitational) {
                        const gravForce = physicsConstants.gravitational * this.mass * otherParticle.type.mass / 
                                         (effectiveDistance * effectiveDistance);
                        // Гравитация намного слабее, поэтому масштабируем сильнее
                        forces.x += gravForce * 1e30;
                        forces.y += gravForce * 1e30;
                    }
                    
                    // Сильное взаимодействие (только для близких расстояний)
                    if (this.interactions.strong && otherParticle.type.interactions.strong && distance < 50) {
                        const strongForce = physicsConstants.strongForce / (distance * distance);
                        forces.x += strongForce;
                        forces.y += strongForce;
                    }
                    
                    return forces;
                }
            }
            
            // Класс частицы
            class Particle {
                constructor(x, y, type) {
                    this.x = x;
                    this.y = y;
                    this.type = type;
                    // Начальная скорость пропорциональна "температуре"
                    this.vx = (Math.random() - 0.5) * 2;
                    this.vy = (Math.random() - 0.5) * 2;
                    this.age = 0;
                }
                
                update(deltaTime) {
                    this.age += deltaTime;
                    
                    // Движение
                    this.x += this.vx * deltaTime;
                    this.y += this.vy * deltaTime;
                    
                    // Тороидальное пространство - вылетают с другой стороны
                    if (this.x < 0) this.x = canvas.width;
                    if (this.x > canvas.width) this.x = 0;
                    if (this.y < 0) this.y = canvas.height;
                    if (this.y > canvas.height) this.y = 0;
                    
                    // Старение и распад
                    if (this.type.lifetime !== Infinity && this.age > this.type.lifetime) {
                        return false; // Частица распалась
                    }
                    
                    return true;
                }
                
                draw() {
                    ctx.beginPath();
                    ctx.arc(this.x, this.y, this.type.displaySize, 0, Math.PI * 2);
                    ctx.fillStyle = this.type.color;
                    ctx.fill();
                    
                    // Обводка для лучшей видимости
                    ctx.strokeStyle = '#2c3e50';
                    ctx.lineWidth = 1;
                    ctx.stroke();
                    
                    // Свечение для определенных типов частиц
                    if (this.type.glow) {
                        ctx.beginPath();
                        ctx.arc(this.x, this.y, this.type.displaySize * 2, 0, Math.PI * 2);
                        const gradient = ctx.createRadialGradient(
                            this.x, this.y, this.type.displaySize,
                            this.x, this.y, this.type.displaySize * 2
                        );
                        gradient.addColorStop(0, this.type.color + 'aa');
                        gradient.addColorStop(1, this.type.color + '00');
                        ctx.fillStyle = gradient;
                        ctx.fill();
                    }
                }
            }
            
            // Предустановленные частицы с реальными параметрами
            const presetParticles = {
                'electron': { 
                    mass: 9.11e-31, 
                    charge: -1.6e-19, 
                    spin: 0.5, 
                    lifetime: Infinity,
                    leptonNumber: 1,
                    interactions: { electromagnetic: true, gravitational: true },
                    glow: true
                },
                'proton': { 
                    mass: 1.67e-27, 
                    charge: 1.6e-19, 
                    spin: 0.5, 
                    lifetime: Infinity,
                    baryonNumber: 1,
                    interactions: { electromagnetic: true, gravitational: true, strong: true }
                },
                'neutron': { 
                    mass: 1.67e-27, 
                    charge: 0, 
                    spin: 0.5, 
                    lifetime: 880, // секунды
                    baryonNumber: 1,
                    interactions: { gravitational: true, strong: true }
                },
                'photon': { 
                    mass: 0, 
                    charge: 0, 
                    spin: 1, 
                    lifetime: Infinity,
                    interactions: { electromagnetic: true },
                    glow: true
                },
                'muon': { 
                    mass: 1.88e-28, 
                    charge: -1.6e-19, 
                    spin: 0.5, 
                    lifetime: 2.2e-6,
                    leptonNumber: 1,
                    interactions: { electromagnetic: true, gravitational: true, weak: true },
                    glow: true
                },
                'quarkUp': { 
                    mass: 2.2e-30, 
                    charge: 2/3 * 1.6e-19, 
                    spin: 0.5, 
                    lifetime: Infinity,
                    baryonNumber: 1/3,
                    interactions: { electromagnetic: true, strong: true }
                },
                'quarkDown': { 
                    mass: 4.7e-30, 
                    charge: -1/3 * 1.6e-19, 
                    spin: 0.5, 
                    lifetime: Infinity,
                    baryonNumber: 1/3,
                    interactions: { electromagnetic: true, strong: true }
                },
                'positron': { 
                    mass: 9.11e-31, 
                    charge: 1.6e-19, 
                    spin: 0.5, 
                    lifetime: Infinity,
                    leptonNumber: -1,
                    interactions: { electromagnetic: true, gravitational: true },
                    glow: true
                },
                'alpha': { 
                    mass: 6.64e-27, 
                    charge: 3.2e-19, 
                    spin: 0, 
                    lifetime: Infinity,
                    baryonNumber: 4,
                    interactions: { electromagnetic: true, gravitational: true, strong: true }
                }
            };
            
            // Создание нового типа частиц
            function createParticleType(name, params = {}) {
                const color = pastelColors[nextColorIndex % pastelColors.length];
                nextColorIndex++;
                
                const type = new ParticleType(name, color, params);
                particleTypes.push(type);
                
                // Сохранение в localStorage
                saveParticleTypes();
                
                // Создание элемента в интерфейсе
                const typeElement = document.createElement('div');
                typeElement.className = 'particle-type';
                typeElement.textContent = name;
                typeElement.style.background = color;
                typeElement.dataset.index = particleTypes.length - 1;
                
                // Кнопка удаления
                const deleteBtn = document.createElement('button');
                deleteBtn.className = 'delete-btn';
                deleteBtn.textContent = '×';
                deleteBtn.addEventListener('click', function(e) {
                    e.stopPropagation();
                    deleteParticleType(parseInt(typeElement.dataset.index));
                });
                
                typeElement.appendChild(deleteBtn);
                typeElement.addEventListener('click', function() {
                    setActiveType(parseInt(this.dataset.index));
                });
                
                particleTypesContainer.appendChild(typeElement);
                
                // Активируем новый тип
                setActiveType(particleTypes.length - 1);
                
                return type;
            }
            
            // Удаление типа частиц
            function deleteParticleType(index) {
                if (particleTypes.length <= 1) {
                    alert('Должен остаться хотя бы один тип частиц');
                    return;
                }
                
                particleTypes.splice(index, 1);
                
                // Перерисовываем интерфейс
                renderParticleTypes();
                
                // Если удалили активный тип, выбираем первый
                if (activeTypeIndex >= particleTypes.length) {
                    setActiveType(0);
                }
                
                // Сохраняем изменения
                saveParticleTypes();
            }
            
            // Сохранение типов частиц в localStorage
            function saveParticleTypes() {
                const typesToSave = particleTypes.map(type => ({
                    name: type.name,
                    color: type.color,
                    mass: type.mass,
                    charge: type.charge,
                    spin: type.spin,
                    lifetime: type.lifetime,
                    interactions: type.interactions,
                    displaySize: type.displaySize,
                    glow: type.glow,
                    leptonNumber: type.leptonNumber,
                    baryonNumber: type.baryonNumber,
                    strangeness: type.strangeness
                }));
                
                localStorage.setItem('particleTypes', JSON.stringify(typesToSave));
            }
            
            // Загрузка типов частиц из localStorage
            function loadParticleTypes() {
                const savedTypes = localStorage.getItem('particleTypes');
                if (savedTypes) {
                    const types = JSON.parse(savedTypes);
                    types.forEach(typeData => {
                        createParticleType(typeData.name, typeData);
                    });
                }
            }
            
            // Отображение списка типов частиц
            function renderParticleTypes() {
                particleTypesContainer.innerHTML = '';
                
                particleTypes.forEach((type, index) => {
                    const typeElement = document.createElement('div');
                    typeElement.className = `particle-type ${index === activeTypeIndex ? 'active' : ''}`;
                    typeElement.textContent = type.name;
                    typeElement.style.background = type.color;
                    typeElement.dataset.index = index;
                    
                    const deleteBtn = document.createElement('button');
                    deleteBtn.className = 'delete-btn';
                    deleteBtn.textContent = '×';
                    deleteBtn.addEventListener('click', function(e) {
                        e.stopPropagation();
                        deleteParticleType(index);
                    });
                    
                    typeElement.appendChild(deleteBtn);
                    typeElement.addEventListener('click', function() {
                        setActiveType(index);
                    });
                    
                    particleTypesContainer.appendChild(typeElement);
                });
            }
            
            // Установка активного типа частиц
            function setActiveType(index) {
                activeTypeIndex = index;
                renderParticleTypes();
                showParticleParams(particleTypes[index]);
            }
            
            // Отображение параметров частицы
            function showParticleParams(type) {
                particleParamsContainer.style.display = 'grid';
                particleParamsContainer.innerHTML = '';
                
                const params = [
                    { name: 'Масса', key: 'mass', min: 1e-35, max: 1e-25, step: 1e-31, unit: 'кг', format: (v) => v.toExponential(2) },
                    { name: 'Заряд', key: 'charge', min: -2e-18, max: 2e-18, step: 1e-19, unit: 'Кл', format: (v) => v.toExponential(2) },
                    { name: 'Спин', key: 'spin', min: 0, max: 2, step: 0.1, unit: 'ħ', format: (v) => v.toFixed(1) },
                    { name: 'Время жизни', key: 'lifetime', min: 1e-9, max: 1e10, step: 1, unit: 'с', format: (v) => v === Infinity ? '∞' : v.toExponential(2) }
                ];
                
                params.forEach(param => {
                    const container = document.createElement('div');
                    container.className = 'param-slider';
                    
                    const label = document.createElement('div');
                    label.className = 'param-label';
                    label.textContent = `${param.name}:`;
                    
                    const slider = document.createElement('input');
                    slider.type = 'range';
                    slider.min = Math.log10(param.min);
                    slider.max = Math.log10(param.max);
                    slider.step = 0.01;
                    slider.value = Math.log10(type[param.key] || 1);
                    
                    const value = document.createElement('div');
                    value.className = 'param-value';
                    value.textContent = `${param.format(type[param.key])} ${param.unit}`;
                    
                    slider.addEventListener('input', function() {
                        type[param.key] = Math.pow(10, parseFloat(this.value));
                        value.textContent = `${param.format(type[param.key])} ${param.unit}`;
                        saveParticleTypes();
                    });
                    
                    container.appendChild(label);
                    container.appendChild(slider);
                    container.appendChild(value);
                    particleParamsContainer.appendChild(container);
                });
                
                // Чекбоксы для взаимодействий
                const interactions = [
                    { name: 'Электромагнитное', key: 'electromagnetic' },
                    { name: 'Гравитационное', key: 'gravitational' },
                    { name: 'Сильное', key: 'strong' },
                    { name: 'Слабое', key: 'weak' }
                ];
                
                interactions.forEach(interaction => {
                    const container = document.createElement('div');
                    container.className = 'param-slider';
                    container.style.gridColumn = '1 / -1';
                    
                    const label = document.createElement('div');
                    label.className = 'param-label';
                    label.textContent = interaction.name + ':';
                    label.style.display = 'inline-block';
                    label.style.width = '70%';
                    
                    const checkbox = document.createElement('input');
                    checkbox.type = 'checkbox';
                    checkbox.checked = type.interactions[interaction.key];
                    checkbox.style.display = 'inline-block';
                    checkbox.style.width = '20%';
                    
                    checkbox.addEventListener('change', function() {
                        type.interactions[interaction.key] = this.checked;
                        saveParticleTypes();
                    });
                    
                    container.appendChild(label);
                    container.appendChild(checkbox);
                    particleParamsContainer.appendChild(container);
                });
            }
            
            // Добавление частицы на экран
            function addParticle(x, y) {
                if (particleTypes.length === 0) return;
                
                const type = particleTypes[activeTypeIndex];
                particles.push(new Particle(x, y, type));
                
                // Ограничение количества частиц для производительности
                if (particles.length > 200) {
                    particles.shift();
                }
            }
            
            // Расчет взаимодействий между частицами
            function calculateInteractions() {
                for (let i = 0; i < particles.length; i++) {
                    for (let j = i + 1; j < particles.length; j++) {
                        const p1 = particles[i];
                        const p2 = particles[j];
                        
                        const dx = p2.x - p1.x;
                        const dy = p2.y - p1.y;
                        const distance = Math.sqrt(dx * dx + dy * dy);
                        
                        if (distance < 200) { // Ограничиваем радиус взаимодействия
                            const force = p1.type.calculateForce(p2, distance);
                            
                            if (force.x !== 0 || force.y !== 0) {
                                // Нормализуем направление
                                const nx = dx / distance;
                                const ny = dy / distance;
                                
                                // Применяем силу с учетом массы
                                const mass1 = p1.type.mass || 1e-30;
                                const mass2 = p2.type.mass || 1e-30;
                                
                                const acceleration1 = force.x / mass1 * 1e-10;
                                const acceleration2 = force.x / mass2 * 1e-10;
                                
                                p1.vx += nx * acceleration1;
                                p1.vy += ny * acceleration1;
                                p2.vx -= nx * acceleration2;
                                p2.vy -= ny * acceleration2;
                            }
                        }
                    }
                }
            }
            
            // Обновление статистики
            function updateStats() {
                frameCount++;
                const now = performance.now();
                if (now - lastFpsUpdate >= 1000) {
                    fps = Math.round(frameCount * 1000 / (now - lastFpsUpdate));
                    statsElement.textContent = `Частиц: ${particles.length} | FPS: ${fps}`;
                    frameCount = 0;
                    lastFpsUpdate = now;
                }
            }
            
            // Основной цикл анимации
            function animate() {
                // Очистка canvas
                ctx.fillStyle = '#f8f9fa';
                ctx.fillRect(0, 0, canvas.width, canvas.height);
                
                // Обновление статистики
                updateStats();
                
                // Расчет взаимодействий
                calculateInteractions();
                
                // Обновление и отрисовка частиц
                for (let i = particles.length - 1; i >= 0; i--) {
                    if (!particles[i].update(0.016)) { // 60 FPS
                        particles.splice(i, 1);
                    } else {
                        particles[i].draw();
                    }
                }
                
                requestAnimationFrame(animate);
            }
            
            // Обработка касаний
            canvas.addEventListener('touchstart', function(e) {
                e.preventDefault();
                const touch = e.touches[0];
                addParticle(touch.clientX, touch.clientY);
            });
            
            canvas.addEventListener('touchmove', function(e) {
                e.preventDefault();
                // Добавляем частицы при движении пальца
                for (let i = 0; i < e.touches.length; i++) {
                    const touch = e.touches[i];
                    if (Math.random() < 0.3) {
                        addParticle(touch.clientX, touch.clientY);
                    }
                }
            });
            
            // Обработка кнопок
            addParticleTypeBtn.addEventListener('click', function() {
                const name = prompt('Введите название для нового типа частиц:', `Частица ${particleTypes.length + 1}`);
                if (name) {
                    createParticleType(name);
                }
            });
            
            clearBtn.addEventListener('click', function() {
                particles = [];
            });
            
            presetButtons.forEach(btn => {
                btn.addEventListener('click', function() {
                    const preset = this.dataset.preset;
                    const params = presetParticles[preset];
                    const name = this.textContent;
                    createParticleType(name, params);
                });
            });
            
            // Загрузка сохраненных типов и создание начального типа
            loadParticleTypes();
            if (particleTypes.length === 0) {
                createParticleType('Электрон', presetParticles.electron);
            }
            
            // Запуск анимации
            animate();
        });
    </script>
</body>
</html>

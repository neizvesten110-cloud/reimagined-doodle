<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>3D Фрактал Мандельброта</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            overflow: hidden;
            touch-action: none;
            -webkit-tap-highlight-color: transparent;
            font-family: Arial, sans-serif;
            background: #000;
        }
        canvas {
            display: block;
        }
        .controls {
            position: absolute;
            bottom: 20px;
            left: 0;
            right: 0;
            text-align: center;
            color: white;
            font-size: 14px;
            pointer-events: none;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.8);
            padding: 0 20px;
            z-index: 100;
        }
        .loading {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-size: 18px;
            text-align: center;
            z-index: 1000;
        }
    </style>
</head>
<body>
    <div class="loading">Загрузка 3D фрактала...</div>
    <div class="controls">Свайп для перемещения · Два пальца для масштабирования</div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Основные переменные
            let camera, scene, renderer;
            let fractalMesh;
            let isRotating = false;
            let previousTouchDistance = null;
            let initialTouches = [];
            
            // Параметры фрактала
            const fractalParams = {
                resolution: 28,  // Уменьшено для производительности на мобильных
                iterations: 10,
                scale: 2.0,
                power: 8,
                offset: new THREE.Vector3(0, 0, 0)
            };
            
            // Инициализация сцены
            function init() {
                // Создание сцены
                scene = new THREE.Scene();
                scene.background = new THREE.Color(0x000000);
                
                // Создание камеры
                const aspectRatio = window.innerWidth / window.innerHeight;
                camera = new THREE.PerspectiveCamera(75, aspectRatio, 0.1, 1000);
                camera.position.z = 5;
                
                // Создание рендерера
                renderer = new THREE.WebGLRenderer({ antialias: true });
                renderer.setSize(window.innerWidth, window.innerHeight);
                renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
                document.body.appendChild(renderer.domElement);
                
                // Добавление освещения
                const ambientLight = new THREE.AmbientLight(0x333333);
                scene.add(ambientLight);
                
                const directionalLight = new THREE.DirectionalLight(0xFFFFFF, 0.7);
                directionalLight.position.set(5, 5, 5);
                scene.add(directionalLight);
                
                // Создание 3D фрактала
                createFractal();
                
                // Обработка событий
                setupEventListeners();
                
                // Скрытие сообщения о загрузке
                document.querySelector('.loading').style.display = 'none';
                
                // Запуск анимации
                animate();
            }
            
            // Создание 3D фрактала Мандельброта
            function createFractal() {
                // Создание геометрии для точек фрактала
                const geometry = new THREE.BufferGeometry();
                const positions = [];
                const colors = [];
                
                // Генерация точек фрактала
                const size = fractalParams.resolution;
                const halfSize = size / 2;
                
                for (let x = 0; x < size; x++) {
                    for (let y = 0; y < size; y++) {
                        for (let z = 0; z < size; z++) {
                            // Нормализованные координаты
                            const nx = (x - halfSize) / halfSize;
                            const ny = (y - halfSize) / halfSize;
                            const nz = (z - halfSize) / halfSize;
                            
                            // Вычисление фрактала
                            const value = mandelbulb(nx, ny, nz, fractalParams);
                            
                            if (value > 0.5) { // Пороговое значение для визуализации
                                positions.push(nx * fractalParams.scale, ny * fractalParams.scale, nz * fractalParams.scale);
                                
                                // Цвет на основе позиции
                                colors.push(
                                    (x / size) * 0.5 + 0.5,
                                    (y / size) * 0.3 + 0.5,
                                    (z / size) * 0.8 + 0.2
                                );
                            }
                        }
                    }
                }
                
                // Установка атрибутов геометрии
                geometry.setAttribute('position', new THREE.Float32BufferAttribute(positions, 3));
                geometry.setAttribute('color', new THREE.Float32BufferAttribute(colors, 3));
                
                // Материал для точек
                const material = new THREE.PointsMaterial({
                    size: 0.05,
                    vertexColors: true,
                    sizeAttenuation: true
                });
                
                // Создание mesh
                fractalMesh = new THREE.Points(geometry, material);
                scene.add(fractalMesh);
            }
            
            // Функция для вычисления 3D фрактала Мандельброта (Mandelbulb)
            function mandelbulb(x, y, z, params) {
                let zx = x;
                let zy = y;
                let zz = z;
                
                let dr = 1.0;
                let r = 0.0;
                
                for (let i = 0; i < params.iterations; i++) {
                    r = Math.sqrt(zx * zx + zy * zy + zz * zz);
                    if (r > 2) break;
                    
                    // Конвертация в сферические координаты
                    const theta = Math.acos(zz / r);
                    const phi = Math.atan2(zy, zx);
                    
                    dr = Math.pow(r, params.power - 1.0) * params.power * dr + 1.0;
                    
                    // Возведение в степень и поворот
                    const zr = Math.pow(r, params.power);
                    theta = theta * params.power;
                    phi = phi * params.power;
                    
                    // Конвертация обратно в декартовы координаты
                    zx = zr * Math.sin(theta) * Math.cos(phi) + x;
                    zy = zr * Math.sin(theta) * Math.sin(phi) + y;
                    zz = zr * Math.cos(theta) + z;
                }
                
                return 0.5 * Math.log(r) * r / dr;
            }
            
            // Настройка обработчиков событий
            function setupEventListeners() {
                // Обработка одинарных касаний (перетаскивание)
                renderer.domElement.addEventListener('touchstart', onTouchStart, { passive: false });
                renderer.domElement.addEventListener('touchmove', onTouchMove, { passive: false });
                renderer.domElement.addEventListener('touchend', onTouchEnd, { passive: false });
                
                // Обработка изменения размера окна
                window.addEventListener('resize', onWindowResize, false);
            }
            
            // Обработка начала касания
            function onTouchStart(event) {
                event.preventDefault();
                
                if (event.touches.length === 1) {
                    isRotating = true;
                    initialTouches = [{
                        x: event.touches[0].clientX,
                        y: event.touches[0].clientY
                    }];
                } else if (event.touches.length === 2) {
                    isRotating = false;
                    // Расчет начального расстояния между двумя пальцами
                    previousTouchDistance = Math.hypot(
                        event.touches[0].clientX - event.touches[1].clientX,
                        event.touches[0].clientY - event.touches[1].clientY
                    );
                }
            }
            
            // Обработка перемещения пальцев
            function onTouchMove(event) {
                event.preventDefault();
                
                if (event.touches.length === 1 && isRotating) {
                    // Вращение фрактала
                    const touchX = event.touches[0].clientX;
                    const touchY = event.touches[0].clientY;
                    
                    const movementX = touchX - initialTouches[0].x;
                    const movementY = touchY - initialTouches[0].y;
                    
                    fractalMesh.rotation.y += movementX * 0.01;
                    fractalMesh.rotation.x += movementY * 0.01;
                    
                    initialTouches[0] = { x: touchX, y: touchY };
                } else if (event.touches.length === 2) {
                    // Масштабирование фрактала
                    const touchDistance = Math.hypot(
                        event.touches[0].clientX - event.touches[1].clientX,
                        event.touches[0].clientY - event.touches[1].clientY
                    );
                    
                    if (previousTouchDistance !== null) {
                        const zoomFactor = touchDistance / previousTouchDistance;
                        camera.position.z *= 1 / zoomFactor;
                        
                        // Ограничение масштабирования
                        camera.position.z = Math.max(2, Math.min(20, camera.position.z));
                    }
                    
                    previousTouchDistance = touchDistance;
                }
            }
            
            // Обработка завершения касания
            function onTouchEnd(event) {
                event.preventDefault();
                isRotating = false;
                previousTouchDistance = null;
            }
            
            // Обработка изменения размера окна
            function onWindowResize() {
                camera.aspect = window.innerWidth / window.innerHeight;
                camera.updateProjectionMatrix();
                renderer.setSize(window.innerWidth, window.innerHeight);
            }
            
            // Функция анимации
            function animate() {
                requestAnimationFrame(animate);
                
                // Медленное автоматическое вращение
                fractalMesh.rotation.y += 0.003;
                
                renderer.render(scene, camera);
            }
            
            // Запуск инициализации
            init();
        });
    </script>
</body>
</html>
